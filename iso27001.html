<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ISO/IEC 27002:2022 Cloud Controls Mapping</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <header>
            <h1>ISO/IEC 27002:2022 Cloud Controls Mapping</h1>
            <h3 class="sub-title">Professional cloud security compliance mapping tool</h3>
            <div class="app-status" id="appStatus">
                <span class="status-indicator" id="statusIndicator">üîÑ</span>
                <span class="status-text" id="statusText">Initializing...</span>
            </div>
        </header>
        
        <section class="cloud-provider-selection">
            <h3>üåê Choose Your Cloud Provider(s)</h3>
            <p class="provider-description">Select which cloud providers you want to see control mappings for.</p>
            
            <div class="provider-checkboxes">
                <label class="provider-checkbox">
                    <input type="checkbox" id="aws-provider" checked>
                    <span class="checkmark aws-checkmark">üî∂ AWS</span>
                </label>
                <label class="provider-checkbox">
                    <input type="checkbox" id="azure-provider" checked>
                    <span class="checkmark azure-checkmark">üî∑ Azure</span>
                </label>
                <label class="provider-checkbox">
                    <input type="checkbox" id="gcp-provider" checked>
                    <span class="checkmark gcp-checkmark">üîµ Google Cloud</span>
                </label>
            </div>
        </section>
        
        <!-- ENHANCED PROGRESS SECTION -->
        <section class="progress-bar-container">
            <h3 style="margin-bottom: 15px;">üìä Compliance Progress</h3>
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill">0%</div>
            </div>
            <div class="stats-container" id="statsContainer">
                <!-- Stats will be injected here -->
            </div>
        </section>
        
        <!-- VIEW CONTROLS -->
        <section class="view-controls-section">
            <div class="view-modes">
                <h3>üëÅÔ∏è View Mode</h3>
                <div class="view-buttons">
                    <button class="view-btn active" data-view="cards" title="Card View">
                        <span class="view-icon">üóÇÔ∏è</span> Cards
                    </button>
                    <button class="view-btn" data-view="list" title="List View">
                        <span class="view-icon">üìã</span> List
                    </button>
                    <button class="view-btn" data-view="checklist" title="Checklist View">
                        <span class="view-icon">‚òëÔ∏è</span> Checklist
                    </button>
                    <button class="view-btn" data-view="kanban" title="Kanban Board">
                        <span class="view-icon">üìä</span> Kanban
                    </button>
                </div>
            </div>
        </section>
        
        <section class="filter-section">
            <h3>üîç Filter & Export Controls</h3>
            <div class="filter-controls">
                <input type="text" id="searchInput" placeholder="Search controls...">
                <select id="categoryFilter">
                    <option value="">All Categories</option>
                    <option value="5">5 - Organizational</option>
                    <option value="6">6 - People</option>
                    <option value="7">7 - Physical</option>
                    <option value="8">8 - Technological</option>
                </select>
                <select id="statusFilter">
                    <option value="">All Statuses</option>
                    <option value="implemented">‚úÖ Implemented</option>
                    <option value="in-progress">‚ö° In Progress</option>
                    <option value="not-implemented">‚¨ú Not Started</option>
                    <option value="not-applicable">‚ûñ Not Applicable</option>
                </select>
                <button class="export-btn" onclick="window.app?.showExportDialog()">üìä Export Report</button>
                <button class="reset-btn" onclick="window.app?.resetFilters()">üîÑ Reset</button>
                <a href="index.html" class="action-btn secondary-btn">‚¨ÖÔ∏è Back to Frameworks</a>
            </div>
            
            <!-- FILTER CHIPS -->
            <div class="filter-chips-container" id="filterChips">
                <!-- Dynamic filter chips will be rendered here -->
            </div>
            
            <!-- ACTIVE FILTERS -->
            <div class="active-filters-container" id="activeFilters" hidden>
                <!-- Active filters will be rendered here -->
            </div>
        </section>
        
        <section class="controls-container">
            <div class="controls-grid" id="controlsGrid">
                <!-- Controls will be loaded here -->
            </div>
        </section>
        
        <div class="loading-spinner" id="loadingSpinner">
            <div class="spinner"></div>
            <p>Loading controls...</p>
        </div>
    </div>
    
    <!-- EXPORT DIALOG -->
    <div class="export-dialog" id="exportDialog" hidden>
        <div class="export-dialog-content">
            <div class="export-header">
                <h2>üìä Export Compliance Report</h2>
                <button class="close-btn" onclick="window.app?.closeExportDialog()">√ó</button>
            </div>
            
            <div class="export-body">
                <h3>Export Options</h3>
                
                <div class="export-option">
                    <label>
                        <input type="checkbox" id="optExecSummary" checked>
                        Include Executive Summary
                    </label>
                </div>
                
                <div class="export-option">
                    <label>
                        <input type="checkbox" id="optProgressCharts" checked>
                        Include Progress Charts
                    </label>
                </div>
                
                <div class="export-option">
                    <label>
                        <input type="checkbox" id="optImplementation" checked>
                        Include Implementation Guides
                    </label>
                </div>
                
                <div class="export-option">
                    <label>
                        <input type="checkbox" id="optCloudMappings" checked>
                        Include Cloud Mappings
                    </label>
                </div>
                
                <h3>Controls to Export</h3>
                <div class="export-option">
                    <label>
                        <input type="radio" name="controlsFilter" value="all" checked>
                        All Controls
                    </label>
                </div>
                <div class="export-option">
                    <label>
                        <input type="radio" name="controlsFilter" value="filtered">
                        Currently Filtered Controls Only
                    </label>
                </div>
                <div class="export-option">
                    <label>
                        <input type="radio" name="controlsFilter" value="implemented">
                        Implemented Controls Only
                    </label>
                </div>
            </div>
            
            <div class="export-footer">
                <button class="btn secondary-btn" onclick="window.app?.closeExportDialog()">Cancel</button>
                <button class="btn export-btn" onclick="window.app?.exportToExcel()">üìä Excel</button>
                <button class="btn export-btn" onclick="window.app?.exportToPDF()">üìÑ PDF</button>
            </div>
        </div>
    </div>

    <!-- External Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <!-- Data Files - ORIGINAL ORDER -->
    <script src="data/base-controls.js"></script>
    <script src="data/azure-controls.js"></script>
    <script src="data/aws-controls.js"></script>
    <script src="data/gcp-controls.js"></script>
    <script src="data/controls-data.js"></script>
    
    <!-- App Initialization - Simplified Version -->
    <script>
        console.log('üöÄ Starting ISO27002 app initialization...');
        
        // Simplified App for ISO27002
        class SimpleISO27002App {
            constructor() {
                this.allControls = [];
                this.currentControls = [];
                this.selectedProviders = new Set(['aws', 'azure', 'gcp']);
                this.complianceStatus = new Map();
                this.currentView = 'cards';
                this.filters = {
                    search: '',
                    category: '',
                    status: ''
                };
                this.loadComplianceStatus();
            }

            async init() {
                try {
                    // Check if controls are loaded
                    if (!window.ISO27002_CONTROLS) {
                        throw new Error('Controls data not loaded');
                    }

                    this.allControls = window.ISO27002_CONTROLS;
                    console.log('‚úÖ Loaded', this.allControls.length, 'controls');

                    // Bind events
                    this.bindEvents();
                    this.initViewModes();

                    // Initial render
                    this.applyFilters();
                    this.updateProgress();

                    // Update status
                    document.getElementById('statusIndicator').textContent = '‚úÖ';
                    document.getElementById('statusText').textContent = `Ready - ${this.allControls.length} controls loaded`;

                    // Hide loading spinner
                    const spinner = document.getElementById('loadingSpinner');
                    if (spinner) spinner.style.display = 'none';

                    console.log('‚úÖ App initialized successfully!');
                } catch (error) {
                    console.error('Init error:', error);
                    throw error;
                }
            }

            bindEvents() {
                // Provider checkboxes
                ['aws-provider', 'azure-provider', 'gcp-provider'].forEach(id => {
                    const checkbox = document.getElementById(id);
                    if (checkbox) {
                        checkbox.addEventListener('change', (e) => {
                            const provider = id.replace('-provider', '');
                            if (e.target.checked) {
                                this.selectedProviders.add(provider);
                            } else {
                                this.selectedProviders.delete(provider);
                            }
                            this.renderControls(this.currentControls);
                            this.updateProgress();
                        });
                    }
                });

                // Search and filters
                const searchInput = document.getElementById('searchInput');
                if (searchInput) {
                    searchInput.addEventListener('input', () => {
                        this.filters.search = searchInput.value;
                        this.applyFilters();
                    });
                }

                const categoryFilter = document.getElementById('categoryFilter');
                if (categoryFilter) {
                    categoryFilter.addEventListener('change', () => {
                        this.filters.category = categoryFilter.value;
                        this.applyFilters();
                    });
                }

                const statusFilter = document.getElementById('statusFilter');
                if (statusFilter) {
                    statusFilter.addEventListener('change', () => {
                        this.filters.status = statusFilter.value;
                        this.applyFilters();
                    });
                }

                // Status dropdowns (event delegation)
                document.addEventListener('change', (e) => {
                    if (e.target.matches('.status-dropdown')) {
                        const controlId = e.target.dataset.controlId;
                        const status = e.target.value;
                        this.saveComplianceStatus(controlId, status);
                        this.updateProgress();
                        // Update card class
                        const card = e.target.closest('.control-card');
                        if (card) {
                            card.className = `control-card status-${status || 'not-started'}`;
                        }
                    }
                });
            }

            initViewModes() {
                const viewButtons = document.querySelectorAll('.view-btn');
                viewButtons.forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const view = e.currentTarget.dataset.view;
                        this.switchView(view);
                    });
                });
            }

            switchView(view) {
                this.currentView = view;
                document.querySelectorAll('.view-btn').forEach(btn => {
                    btn.classList.toggle('active', btn.dataset.view === view);
                });
                this.renderControls(this.currentControls);
            }

            applyFilters() {
                let filtered = [...this.allControls];

                if (this.filters.search) {
                    const term = this.filters.search.toLowerCase();
                    filtered = filtered.filter(control =>
                        control.id.toLowerCase().includes(term) ||
                        control.title.toLowerCase().includes(term) ||
                        control.implementation.toLowerCase().includes(term)
                    );
                }

                if (this.filters.category) {
                    filtered = filtered.filter(control => control.category === this.filters.category);
                }

                if (this.filters.status) {
                    filtered = filtered.filter(control => {
                        const status = this.complianceStatus.get(control.id);
                        return status && status.status === this.filters.status;
                    });
                }

                this.currentControls = filtered;
                this.renderControls(filtered);
            }

            renderControls(controls) {
                const grid = document.getElementById('controlsGrid');
                if (!grid) return;

                grid.innerHTML = '';
                grid.className = `controls-grid view-${this.currentView}`;

                controls.forEach(control => {
                    const card = this.createControlCard(control);
                    grid.appendChild(card);
                });
            }

            createControlCard(control) {
                const card = document.createElement('div');
                const status = this.complianceStatus.get(control.id);
                const statusValue = status ? status.status : '';
                const statusClass = statusValue ? `status-${statusValue}` : 'status-not-started';
                card.className = `control-card ${statusClass}`;

                // Get cloud mappings
                let cloudMappingsHTML = '';
                const providers = [];
                if (this.selectedProviders.has('aws') && control.cloudMappings?.aws) {
                    providers.push({ key: 'aws', icon: 'üî∂', name: 'AWS', content: control.cloudMappings.aws });
                }
                if (this.selectedProviders.has('azure') && control.cloudMappings?.azure) {
                    providers.push({ key: 'azure', icon: 'üî∑', name: 'Azure', content: control.cloudMappings.azure });
                }
                if (this.selectedProviders.has('gcp') && control.cloudMappings?.gcp) {
                    providers.push({ key: 'gcp', icon: 'üîµ', name: 'GCP', content: control.cloudMappings.gcp });
                }

                if (providers.length > 0) {
                    const tabsHTML = providers.map((p, idx) => `
                        <button class="tab ${idx === 0 ? 'active' : ''}" data-tab="${p.key}" onclick="window.app.switchTab(event, '${p.key}')">
                            <span class="provider-icon">${p.icon}</span> ${p.name}
                        </button>
                    `).join('');

                    const contentHTML = providers.map((p, idx) => `
                        <div class="cloud-content" data-content="${p.key}" ${idx === 0 ? '' : 'hidden'}>${this.escapeHtml(p.content)}</div>
                    `).join('');

                    cloudMappingsHTML = `
                        <details class="section-collapsible" open>
                            <summary class="section-header">
                                <span><span class="icon">‚òÅÔ∏è</span><strong>Cloud Implementation</strong></span>
                                <span class="expand-icon">‚ñº</span>
                            </summary>
                            <div class="section-content">
                                <div class="cloud-tabs">${tabsHTML}</div>
                                ${contentHTML}
                            </div>
                        </details>
                    `;
                }

                card.innerHTML = `
                    <div class="control-status-indicator">
                        <span class="status-badge ${statusValue || 'not-started'}">${this.getStatusLabel(statusValue)}</span>
                    </div>
                    
                    <div class="control-header">
                        <div class="control-id">${this.escapeHtml(control.id)}</div>
                    </div>
                    <div class="control-title">${this.escapeHtml(control.title)}</div>
                    
                    <details class="section-collapsible" open>
                        <summary class="section-header">
                            <span><span class="icon">üìã</span><strong>Implementation Guide</strong></span>
                            <span class="expand-icon">‚ñº</span>
                        </summary>
                        <div class="section-content">${this.escapeHtml(control.implementation)}</div>
                    </details>
                    
                    ${cloudMappingsHTML}
                    
                    <details class="section-collapsible">
                        <summary class="section-header">
                            <span><span class="icon">üìä</span><strong>Audit Evidence</strong></span>
                            <span class="expand-icon">‚ñº</span>
                        </summary>
                        <div class="section-content">${this.escapeHtml(control.evidence)}</div>
                    </details>
                    
                    <div class="control-footer">
                        <select class="status-dropdown" data-control-id="${this.escapeHtml(control.id)}">
                            <option value="">Select Status</option>
                            <option value="implemented" ${statusValue === 'implemented' ? 'selected' : ''}>‚úÖ Implemented</option>
                            <option value="in-progress" ${statusValue === 'in-progress' ? 'selected' : ''}>‚ö° In Progress</option>
                            <option value="not-implemented" ${statusValue === 'not-implemented' ? 'selected' : ''}>‚¨ú Not Implemented</option>
                            <option value="not-applicable" ${statusValue === 'not-applicable' ? 'selected' : ''}>‚ûñ Not Applicable</option>
                        </select>
                    </div>
                `;

                return card;
            }

            switchTab(event, tabKey) {
                event.preventDefault();
                const parent = event.target.closest('.section-content');
                parent.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                event.target.closest('.tab').classList.add('active');
                parent.querySelectorAll('.cloud-content').forEach(content => {
                    content.hidden = content.dataset.content !== tabKey;
                });
            }

            escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text || '';
                return div.innerHTML;
            }

            getStatusLabel(status) {
                const labels = {
                    'implemented': '‚úÖ Implemented',
                    'in-progress': '‚ö° In Progress',
                    'not-implemented': '‚¨ú Not Started',
                    'not-applicable': '‚ûñ Not Applicable',
                    '': '‚¨ú Not Started'
                };
                return labels[status] || '‚¨ú Not Started';
            }

            loadComplianceStatus() {
                try {
                    const saved = localStorage.getItem('iso27002-compliance-status');
                    if (saved) {
                        const data = JSON.parse(saved);
                        this.complianceStatus = new Map(Object.entries(data));
                    }
                } catch (e) {
                    console.warn('Could not load compliance status:', e);
                }
            }

            saveComplianceStatus(controlId, status) {
                this.complianceStatus.set(controlId, { status, comments: '' });
                const data = Object.fromEntries(this.complianceStatus);
                localStorage.setItem('iso27002-compliance-status', JSON.stringify(data));
            }

            updateProgress() {
                const progressFill = document.getElementById('progressFill');
                const statsContainer = document.getElementById('statsContainer');
                
                if (!progressFill || !statsContainer) return;

                const total = this.allControls.length;
                let implemented = 0;
                let inProgress = 0;
                let notImplemented = 0;

                this.allControls.forEach(control => {
                    const status = this.complianceStatus.get(control.id);
                    if (status) {
                        if (status.status === 'implemented') implemented++;
                        else if (status.status === 'in-progress') inProgress++;
                        else notImplemented++;
                    } else {
                        notImplemented++;
                    }
                });

                const percentage = total > 0 ? Math.round((implemented / total) * 100) : 0;
                progressFill.style.width = percentage + '%';
                progressFill.textContent = percentage + '%';

                statsContainer.innerHTML = `
                    <div class="stat-card">
                        <div class="stat-number">${total}</div>
                        <div class="stat-label">Total Controls</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${implemented}</div>
                        <div class="stat-label">Implemented</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${inProgress}</div>
                        <div class="stat-label">In Progress</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${notImplemented}</div>
                        <div class="stat-label">Remaining</div>
                    </div>
                `;
            }

            showExportDialog() {
                const dialog = document.getElementById('exportDialog');
                if (dialog) dialog.hidden = false;
            }

            closeExportDialog() {
                const dialog = document.getElementById('exportDialog');
                if (dialog) dialog.hidden = true;
            }

            exportToExcel() {
                if (!window.XLSX) {
                    alert('Excel library not loaded');
                    return;
                }

                const data = this.currentControls.map(c => ({
                    'Control ID': c.id,
                    'Title': c.title,
                    'Category': c.category,
                    'Implementation': c.implementation,
                    'Evidence': c.evidence,
                    'AWS': c.cloudMappings?.aws || 'N/A',
                    'Azure': c.cloudMappings?.azure || 'N/A',
                    'GCP': c.cloudMappings?.gcp || 'N/A',
                    'Status': this.complianceStatus.get(c.id)?.status || 'Not Set'
                }));

                const ws = XLSX.utils.json_to_sheet(data);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, 'ISO27002 Controls');

                const timestamp = new Date().toISOString().slice(0, 10);
                XLSX.writeFile(wb, `ISO27002_Audit_Report_${timestamp}.xlsx`);
                this.closeExportDialog();
            }

            exportToPDF() {
                alert('PDF export feature will be available soon!');
                this.closeExportDialog();
            }

            resetFilters() {
                document.getElementById('searchInput').value = '';
                document.getElementById('categoryFilter').value = '';
                const statusFilter = document.getElementById('statusFilter');
                if (statusFilter) statusFilter.value = '';
                this.filters = { search: '', category: '', status: '' };
                this.applyFilters();
            }
        }

        // Initialize app
        async function initApp() {
            try {
                if (!window.ISO27002_CONTROLS) {
                    console.error('‚ùå Controls not loaded!');
                    alert('Failed to load ISO 27002 controls. Please refresh the page.');
                    return;
                }

                window.app = new SimpleISO27002App();
                await window.app.init();

            } catch (error) {
                console.error('‚ùå Failed to initialize app:', error);
                alert('Failed to initialize application. Please refresh the page.\n\nError: ' + error.message);
            }
        }

        // Start app when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initApp);
        } else {
            initApp();
        }
    </script>
</body>
</html>