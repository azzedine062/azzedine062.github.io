<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ISO/IEC 27018:2019 PII Protection Checklist</title>
    <link rel="stylesheet" href="styles.css">
   
</head>
<body>
    <div class="container">
        <header>
            <h1>üîí ISO/IEC 27018:2019 PII Protection Checklist</h1>
            <div class="framework-badge">Privacy Protection in Public Cloud</div>
            <h3 class="sub-title">Comprehensive checklist for protecting personally identifiable information (PII) in cloud services</h3>
            <div class="app-status">
                <span class="status-indicator" id="statusIndicator">üîÑ</span>
                <span class="status-text" id="statusText">Loading...</span>
            </div>
        </header>

        <!-- Progress Section -->
        <section class="progress-bar-container">
            <h3 style="margin-bottom: 15px;">üìä GDPR Compliance Progress</h3>
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill">0%</div>
            </div>
            <div class="stats-container">
                <div class="stat-card">
                    <div class="stat-number" id="totalControls">0</div>
                    <div class="stat-label">Total Controls</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="implementedCount">0</div>
                    <div class="stat-label">Implemented</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="remainingCount">0</div>
                    <div class="stat-label">Remaining</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="progressPercent">0%</div>
                    <div class="stat-label">Complete</div>
                </div>
            </div>
        </section>

        <!-- Action Buttons -->
        <section class="action-buttons">
            <button class="action-btn primary-btn" onclick="exportToExcel()">üìä Export GDPR Report</button>
            <button class="action-btn secondary-btn" onclick="checkAll()">‚úÖ Check All</button>
            <button class="action-btn secondary-btn" onclick="uncheckAll()">‚¨ú Uncheck All</button>
            <button class="action-btn secondary-btn" onclick="resetProgress()">üîÑ Reset Progress</button>
            <a href="index.html" class="action-btn secondary-btn">‚¨ÖÔ∏è Back to Frameworks</a>
        </section>

        <!-- Filter Section -->
        <section class="filter-section">
            <h3>üîç Filter Controls</h3>
            <div class="filter-controls">
                <input type="text" id="searchInput" placeholder="Search controls or GDPR articles...">
                <select id="categoryFilter">
                    <option value="">All Categories</option>
                    <option value="organizational">Organizational</option>
                    <option value="technical">Technical</option>
                    <option value="operational">Operational</option>
                </select>
                <button class="reset-btn" onclick="resetFilters()" style="margin-left: 10px;">üîÑ Reset Filters</button>
            </div>
        </section>

        <!-- Controls Container -->
        <section class="controls-container">
            <div class="controls-grid" id="controlsGrid">
                <!-- Controls will be loaded here -->
            </div>
        </section>
    </div>

    <!-- Data File -->
    <script src="data/iso27018-controls.js"></script>
    
    <!-- XLSX Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <!-- Application Logic -->
    <script>
        class ISO27018App {
            constructor() {
                this.allControls = [];
                this.currentControls = [];
                this.checkedItems = new Set();
                this.filters = {
                    search: '',
                    category: ''
                };
                this.loadCheckedState();
            }

            init() {
                if (!window.ISO27018_CONTROLS) {
                    alert('Failed to load ISO 27018 controls data');
                    return;
                }

                this.allControls = window.ISO27018_CONTROLS;
                console.log('‚úÖ Loaded', this.allControls.length, 'ISO 27018 controls');

                this.bindEvents();
                this.applyFilters();
                this.updateProgress();

                document.getElementById('statusIndicator').textContent = '‚úÖ';
                document.getElementById('statusText').textContent = `Ready - ${this.allControls.length} PII protection controls loaded`;
            }

            bindEvents() {
                document.getElementById('searchInput').addEventListener('input', (e) => {
                    this.filters.search = e.target.value;
                    this.applyFilters();
                });

                document.getElementById('categoryFilter').addEventListener('change', (e) => {
                    this.filters.category = e.target.value;
                    this.applyFilters();
                });

                document.addEventListener('change', (e) => {
                    if (e.target.matches('.checklist-checkbox')) {
                        this.handleCheckboxChange(e.target);
                    }
                });
            }

            applyFilters() {
                let filtered = [...this.allControls];

                if (this.filters.search) {
                    const term = this.filters.search.toLowerCase();
                    filtered = filtered.filter(control =>
                        control.id.toLowerCase().includes(term) ||
                        control.title.toLowerCase().includes(term) ||
                        control.description.toLowerCase().includes(term) ||
                        control.gdprMapping.toLowerCase().includes(term) ||
                        control.implementation.toLowerCase().includes(term)
                    );
                }

                if (this.filters.category) {
                    filtered = filtered.filter(control => control.category === this.filters.category);
                }

                this.currentControls = filtered;
                this.renderControls(filtered);
            }

            renderControls(controls) {
                const grid = document.getElementById('controlsGrid');
                grid.innerHTML = '';

                controls.forEach(control => {
                    const card = this.createControlCard(control);
                    grid.appendChild(card);
                });
            }

            createControlCard(control) {
                const card = document.createElement('div');
                card.className = 'control-card';

                const isChecked = this.checkedItems.has(control.id);
                const checkedClass = isChecked ? 'checked' : '';

                card.innerHTML = `
                    <div class="control-header">
                        <div class="control-id">${control.id}</div>
                        <div class="control-header-badges">
                            <span class="control-type-badge pii-specific">üîí PII Protection</span>
                            <span class="gdpr-badge">${control.gdprMapping}</span>
                        </div>
                    </div>
                    <div class="control-title">${control.title}</div>

                    <div class="checklist-item ${checkedClass}">
                        <input type="checkbox" 
                               class="checklist-checkbox" 
                               data-control-id="${control.id}"
                               ${isChecked ? 'checked' : ''}>
                        <div class="checklist-content">
                            <strong class="checklist-text">üìù ${control.description}</strong>
                        </div>
                    </div>

                    <div class="implementation-guide">
                        <h4>üîß Implementation Steps</h4>
                        <div>${control.implementation}</div>
                    </div>

                    <div class="guidance-section">
                        <h4>üí° Best Practice Guidance</h4>
                        <div>${control.guidance}</div>
                    </div>

                    <div class="audit-evidence">
                        <h4>üìä Required Evidence</h4>
                        <div class="evidence-list">${control.evidence}</div>
                    </div>

                    <div class="compliance-note">
                        <h4>‚öñÔ∏è Compliance Notes</h4>
                        <div>${control.complianceNotes}</div>
                    </div>
                `;

                return card;
            }

            handleCheckboxChange(checkbox) {
                const controlId = checkbox.dataset.controlId;
                const item = checkbox.closest('.checklist-item');

                if (checkbox.checked) {
                    this.checkedItems.add(controlId);
                    item.classList.add('checked');
                } else {
                    this.checkedItems.delete(controlId);
                    item.classList.remove('checked');
                }

                this.saveCheckedState();
                this.updateProgress();
            }

            updateProgress() {
                const total = this.allControls.length;
                const implemented = this.checkedItems.size;
                const remaining = total - implemented;
                const percentage = total > 0 ? Math.round((implemented / total) * 100) : 0;

                document.getElementById('totalControls').textContent = total;
                document.getElementById('implementedCount').textContent = implemented;
                document.getElementById('remainingCount').textContent = remaining;
                document.getElementById('progressPercent').textContent = percentage + '%';
                document.getElementById('progressFill').style.width = percentage + '%';
                document.getElementById('progressFill').textContent = percentage + '%';
            }

            saveCheckedState() {
                try {
                    localStorage.setItem('iso27018-checked-items', JSON.stringify([...this.checkedItems]));
                } catch (e) {
                    console.warn('Could not save state:', e);
                }
            }

            loadCheckedState() {
                try {
                    const saved = localStorage.getItem('iso27018-checked-items');
                    if (saved) {
                        this.checkedItems = new Set(JSON.parse(saved));
                    }
                } catch (e) {
                    console.warn('Could not load state:', e);
                }
            }
        }

        // Global functions
        function checkAll() {
            if (!window.app) return;
            window.app.allControls.forEach(control => {
                window.app.checkedItems.add(control.id);
            });
            window.app.saveCheckedState();
            window.app.updateProgress();
            window.app.applyFilters();
            alert('‚úÖ All PII protection controls marked as implemented!');
        }

        function uncheckAll() {
            if (!window.app) return;
            if (confirm('Are you sure you want to uncheck all controls?')) {
                window.app.checkedItems.clear();
                window.app.saveCheckedState();
                window.app.updateProgress();
                window.app.applyFilters();
                alert('‚¨ú All controls unmarked.');
            }
        }

        function resetProgress() {
            if (!window.app) return;
            if (confirm('Are you sure you want to reset all progress? This cannot be undone.')) {
                window.app.checkedItems.clear();
                window.app.saveCheckedState();
                window.app.updateProgress();
                window.app.applyFilters();
                alert('üîÑ Progress reset successfully.');
            }
        }

        function resetFilters() {
            if (!window.app) return;
            document.getElementById('searchInput').value = '';
            document.getElementById('categoryFilter').value = '';
            window.app.filters = { search: '', category: '' };
            window.app.applyFilters();
        }

        function exportToExcel() {
            if (!window.XLSX) {
                alert('Excel library not loaded. Please check your internet connection.');
                return;
            }

            if (!window.app) {
                alert('App not initialized');
                return;
            }

            const controls = window.app.currentControls;
            const checkedItems = window.app.checkedItems;

            const exportData = controls.map(control => ({
                'Control ID': control.id,
                'Control Title': control.title,
                'GDPR Mapping': control.gdprMapping,
                'Category': control.category.charAt(0).toUpperCase() + control.category.slice(1),
                'Status': checkedItems.has(control.id) ? '‚úÖ Implemented' : '‚ùå Not Implemented',
                'Description': control.description,
                'Implementation Steps': control.implementation,
                'Best Practice Guidance': control.guidance,
                'Required Evidence': control.evidence,
                'Compliance Notes': control.complianceNotes
            }));

            const ws = XLSX.utils.json_to_sheet(exportData);
            ws['!cols'] = [
                { wch: 10 }, { wch: 40 }, { wch: 30 }, { wch: 15 }, 
                { wch: 15 }, { wch: 60 }, { wch: 60 }, { wch: 60 }, 
                { wch: 60 }, { wch: 60 }
            ];

            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'ISO 27018 PII Controls');

            const total = window.app.allControls.length;
            const implemented = checkedItems.size;
            const percentage = Math.round((implemented / total) * 100);

            const categoryCounts = { 
                organizational: { total: 0, implemented: 0 }, 
                technical: { total: 0, implemented: 0 }, 
                operational: { total: 0, implemented: 0 } 
            };

            window.app.allControls.forEach(control => {
                categoryCounts[control.category].total++;
                if (checkedItems.has(control.id)) {
                    categoryCounts[control.category].implemented++;
                }
            });

            const summaryData = [
                ['ISO/IEC 27018:2019 PII Protection Report', ''],
                ['Generated', new Date().toLocaleString()],
                ['Report Type', 'GDPR Compliance Assessment'],
                ['', ''],
                ['Overall GDPR Compliance Progress', ''],
                ['Total Controls', total],
                ['Implemented', implemented],
                ['Not Implemented', total - implemented],
                ['Compliance Rate', percentage + '%'],
                ['', ''],
                ['Progress by Category', 'Implemented / Total'],
                ['Organizational Controls', `${categoryCounts.organizational.implemented} / ${categoryCounts.organizational.total}`],
                ['Technical Controls', `${categoryCounts.technical.implemented} / ${categoryCounts.technical.total}`],
                ['Operational Controls', `${categoryCounts.operational.implemented} / ${categoryCounts.operational.total}`],
                ['', ''],
                ['Key GDPR Articles Covered', ''],
                ['Article 28 (Processor obligations)', 'Multiple controls'],
                ['Article 32 (Security of processing)', 'Multiple controls'],
                ['Article 33 (Breach notification)', 'Control A.11.1'],
                ['Article 35 (Data protection impact assessment)', 'Control A.17.1'],
                ['Chapter V (International transfers)', 'Control A.12.1']
            ];

            const summaryWs = XLSX.utils.aoa_to_sheet(summaryData);
            summaryWs['!cols'] = [{ wch: 35 }, { wch: 25 }];
            XLSX.utils.book_append_sheet(wb, summaryWs, 'GDPR Compliance Summary');

            const timestamp = new Date().toISOString().slice(0, 10);
            const filename = `ISO27018_GDPR_Compliance_Report_${timestamp}.xlsx`;

            XLSX.writeFile(wb, filename);
            alert(`‚úÖ GDPR compliance report exported!\n\nFile: ${filename}\nControls: ${controls.length}\nGDPR Compliance: ${percentage}%`);
        }

        // Initialize app
        document.addEventListener('DOMContentLoaded', () => {
            // Add small delay to ensure script loads
            setTimeout(() => {
                console.log('Checking ISO27018_CONTROLS:', typeof window.ISO27018_CONTROLS);
                
                if (!window.ISO27018_CONTROLS) {
                    console.error('ISO27018_CONTROLS not loaded!');
                    alert('ERROR: ISO 27018 data file not loaded.\n\nPlease ensure:\n1. File data/iso27018-controls.js exists\n2. File is in the correct location\n3. Check browser console (F12) for errors');
                    document.getElementById('statusIndicator').textContent = '‚ùå';
                    document.getElementById('statusText').textContent = 'Failed to load controls';
                    return;
                }
                
                window.app = new ISO27018App();
                window.app.init();
            }, 300);
        });
    </script>
</body>
</html>