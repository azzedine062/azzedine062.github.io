<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CSA Cloud Controls Matrix (CCM) v4 - Azure Mapping</title>
    <link rel="stylesheet" href="styles.css?v=1.0">
    <style>
        /* Additional CCM-specific styles */
        .ccm-domain-header {
            background: #f8f9fa;
            border-left: 4px solid #0078d4;
            color: #2c3e50;
            padding: 0.75rem 1.25rem;
            border-radius: 4px;
            margin: 2.5rem 0 1rem 0;
            font-size: 1.1rem;
            font-weight: 600;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
            transition: all 0.3s ease;
        }

        .ccm-domain-header:hover {
            background: #ffffff;
            box-shadow: 0 2px 8px rgba(0, 120, 212, 0.1);
            border-left-width: 5px;
        }

        .ccm-domain-description {
            color: #6c757d;
            font-size: 0.85rem;
            margin-top: 0.35rem;
            font-weight: 400;
        }

        .control-applicability {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
            margin-left: 0.5rem;
        }

        .applicability-both {
            background: #e3f2fd;
            color: #1976d2;
            border: 1px solid #90caf9;
        }

        .applicability-csp {
            background: #f3e5f5;
            color: #7b1fa2;
            border: 1px solid #ce93d8;
        }

        .applicability-csc {
            background: #e8f5e9;
            color: #388e3c;
            border: 1px solid #81c784;
        }

        .control-specification {
            background: #f8f9fa;
            border-left: 3px solid #0078d4;
            padding: 1rem;
            margin: 1rem 0;
            border-radius: 4px;
        }

        .control-specification h4 {
            margin: 0 0 0.5rem 0;
            color: #0078d4;
            font-size: 0.9rem;
        }

        .ccm-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin: 2rem 0;
        }

        .ccm-stat-card {
            background: white;
            padding: 1.5rem;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            text-align: center;
        }

        .ccm-stat-number {
            font-size: 2.5rem;
            font-weight: 700;
            color: #0078d4;
        }

        .ccm-stat-label {
            color: #666;
            font-size: 0.9rem;
            margin-top: 0.5rem;
        }

        .framework-badge {
            display: inline-block;
            padding: 0.5rem 1rem;
            background: linear-gradient(135deg, #0078d4 0%, #005a9e 100%);
            color: white;
            border-radius: 20px;
            font-weight: 600;
            margin-bottom: 1rem;
        }

        /* Compliance Status Styles */
        .compliance-status-section {
            margin-top: 1.5rem;
            padding-top: 1.5rem;
            border-top: 1px solid #e0e0e0;
        }

        .compliance-status-section h4 {
            margin: 0 0 1rem 0;
            color: #333;
            font-size: 0.95rem;
            font-weight: 600;
        }

        .compliance-status-buttons {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .status-btn {
            padding: 0.5rem 1rem;
            border: 2px solid #ddd;
            background: white;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85rem;
            font-weight: 500;
            transition: all 0.2s ease;
            color: #666;
        }

        .status-btn:hover {
            border-color: #0078d4;
            background: #f8f9fa;
        }

        .status-btn.active {
            font-weight: 600;
            color: white;
        }

        .status-implemented.active {
            background: #28a745;
            border-color: #28a745;
        }

        .status-partial.active {
            background: #ffc107;
            border-color: #ffc107;
            color: #000;
        }

        .status-not-implemented.active {
            background: #dc3545;
            border-color: #dc3545;
        }

        .status-not-applicable.active {
            background: #6c757d;
            border-color: #6c757d;
        }

        /* Auditor Comment Styles */
        .auditor-comment-section {
            margin-top: 1rem;
        }

        .comment-label {
            display: block;
            margin-bottom: 0.5rem;
            color: #333;
            font-size: 0.9rem;
            font-weight: 600;
        }

        .auditor-comment-textarea {
            width: 100%;
            min-height: 80px;
            padding: 0.75rem;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            font-size: 0.9rem;
            resize: vertical;
            transition: border-color 0.2s ease;
        }

        .auditor-comment-textarea:focus {
            outline: none;
            border-color: #0078d4;
            box-shadow: 0 0 0 3px rgba(0, 120, 212, 0.1);
        }

        .auditor-comment-textarea::placeholder {
            color: #999;
            font-style: italic;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="framework-badge">‚òÅÔ∏è CSA CCM v4</div>
            <h1>Cloud Controls Matrix (CCM) v4</h1>
            <p style="color: #666; margin-top: 1rem;">
                The Cloud Security Alliance Cloud Controls Matrix is the industry standard for cloud security assurance and compliance.
            </p>
           <p>¬© This tool references the Cloud Security Alliance (CSA) Cloud Controls Matrix (CCM) v4 for educational and non-commercial purposes.</p>
           <p>Source: https://cloudsecurityalliance.org/artifacts/cloud-controls-matrix-v4/</p> 


            <div class="app-status" id="appStatus">
                <span class="status-indicator" id="statusIndicator">üîÑ</span>
                <span class="status-text" id="statusText">Initializing...</span>
            </div>
        </header>

        <!-- CCM Statistics -->
        <section class="ccm-stats">
            <div class="ccm-stat-card">
                <div class="ccm-stat-number" id="totalControls">0</div>
                <div class="ccm-stat-label">Total Controls</div>
            </div>
            <div class="ccm-stat-card">
                <div class="ccm-stat-number">17</div>
                <div class="ccm-stat-label">Control Domains</div>
            </div>
            <div class="ccm-stat-card">
                <div class="ccm-stat-number" id="azureMappings">0</div>
                <div class="ccm-stat-label">Azure Mappings</div>
            </div>
        </section>
        
        <!-- VIEW CONTROLS -->
        <section class="view-controls-section">
            <div class="view-modes">
                <h3>üëÅÔ∏è View Mode</h3>
                <div class="view-buttons">
                    <button class="view-btn active" data-view="cards" title="Card View">
                        <span class="view-icon">üóÇÔ∏è</span> Cards
                    </button>
                    <button class="view-btn" data-view="list" title="List View">
                        <span class="view-icon">üìã</span> List
                    </button>
                    <button class="view-btn" data-view="kanban" title="Kanban Board">
                        <span class="view-icon">üìä</span> Kanban
                    </button>
                </div>
            </div>
        </section>

        <!-- Cloud Provider Selection -->
        <section class="cloud-provider-selection">
            <h3>üå•Ô∏è Cloud Provider</h3>
            <p class="provider-description">Currently showing Azure mappings. AWS and GCP coming soon.</p>
            
            <div class="provider-checkboxes">
                <label class="provider-checkbox">
                    <input type="checkbox" id="azure-provider" checked disabled>
                    <span class="checkmark azure-checkmark">üî∑ Azure (Active)</span>
                </label>
                <label class="provider-checkbox">
                    <input type="checkbox" id="aws-provider" disabled>
                    <span class="checkmark aws-checkmark">üî∂ AWS (Coming Soon)</span>
                </label>
                <label class="provider-checkbox">
                    <input type="checkbox" id="gcp-provider" disabled>
                    <span class="checkmark gcp-checkmark">üîµ GCP (Coming Soon)</span>
                </label>
            </div>
        </section>
        
        <!-- Filter Section -->
        <section class="filter-section">
            <h3>üîç Filter & Export Controls</h3>
            <div class="filter-controls">
                <input type="text" id="searchInput" placeholder="Search CCM controls...">
                <select id="domainFilter">
                    <option value="">All Domains</option>
                    <option value="A&A">A&A - Audit and Assurance</option>
                    <option value="AIS">AIS - Application & Interface Security</option>
                    <option value="BCR">BCR - Business Continuity & DR</option>
                    <option value="CEK">CEK - Cryptography & Key Management</option>
                    <option value="CCC">CCC - Change Control & Configuration</option>
                    <option value="DSP">DSP - Data Security & Privacy</option>
                    <option value="DCS">DCS - Datacenter Security</option>
                    <option value="GRC">GRC - Governance, Risk & Compliance</option>
                    <option value="HRS">HRS - Human Resources Security</option>
                    <option value="IAM">IAM - Identity & Access Management</option>
                    <option value="IPY">IPY - Interoperability & Portability</option>
                    <option value="IVS">IVS - Infrastructure & Virtualization</option>
                    <option value="LOG">LOG - Logging & Monitoring</option>
                    <option value="SEF">SEF - Security Incident Management</option>
                    <option value="STA">STA - Supply Chain Management</option>
                    <option value="TVM">TVM - Threat & Vulnerability Management</option>
                    <option value="UEM">UEM - Universal Endpoint Management</option>
                </select>
                <button class="export-btn" onclick="window.app?.showExportDialog()">üìä Export Report</button>
                <button class="reset-btn" onclick="window.app?.resetFilters()">üîÑ Reset</button>
                <a href="index.html" class="action-btn secondary-btn">‚¨ÖÔ∏è Back to Frameworks</a>
            </div>
            
            <!-- FILTER CHIPS -->
            <div class="filter-chips-container" id="filterChips">
                <!-- Dynamic filter chips will be rendered here -->
            </div>
        </section>
        
        <!-- Controls Container -->
        <section class="controls-container">
            <div class="controls-grid" id="controlsGrid">
                <!-- Controls will be loaded here -->
            </div>
        </section>
        
        <div class="loading-spinner" id="loadingSpinner">
            <div class="spinner"></div>
            <p>Loading CCM controls...</p>
        </div>
    </div>
    
    <!-- EXPORT DIALOG -->
    <div class="export-dialog" id="exportDialog" hidden>
        <div class="export-dialog-content">
            <div class="export-header">
                <h2>üìä Export CCM Compliance Report</h2>
                <button class="close-btn" onclick="window.app?.closeExportDialog()">√ó</button>
            </div>
            
            <div class="export-body">
                <h3>Export Options</h3>
                
                <div class="export-option">
                    <label>
                        <input type="checkbox" id="optExecSummary" checked>
                        Include Executive Summary
                    </label>
                </div>
                
                <div class="export-option">
                    <label>
                        <input type="checkbox" id="optProgressCharts" checked>
                        Include Progress Charts
                    </label>
                </div>
                
                <div class="export-option">
                    <label>
                        <input type="checkbox" id="optImplementation" checked>
                        Include Control Specifications
                    </label>
                </div>
                
                <div class="export-option">
                    <label>
                        <input type="checkbox" id="optAzureMappings" checked>
                        Include Azure Mappings
                    </label>
                </div>
                
                <h3>Controls to Export</h3>
                <div class="export-option">
                    <label>
                        <input type="radio" name="controlsFilter" value="all" checked>
                        All Controls
                    </label>
                </div>
                <div class="export-option">
                    <label>
                        <input type="radio" name="controlsFilter" value="filtered">
                        Currently Filtered Controls Only
                    </label>
                </div>
                <div class="export-option">
                    <label>
                        <input type="radio" name="controlsFilter" value="implemented">
                        Implemented Controls Only
                    </label>
                </div>
            </div>
            
            <div class="export-footer">
                <button class="btn secondary-btn" onclick="window.app?.closeExportDialog()">Cancel</button>
                <button class="btn export-btn" onclick="window.app?.exportToExcel()">üìä Excel</button>
                <button class="btn export-btn" onclick="window.app?.exportToPDF()">üìÑ PDF</button>
            </div>
        </div>
    </div>

    <!-- External Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <!-- Data Files -->
    <script src="data/ccm-base-controls.js"></script>
    <script src="data/azure-ccm-controls.js"></script>
    
    <!-- Application Logic -->
    <script>
        console.log('üöÄ Starting CCM application...');

        class CCMApp {
            constructor() {
                this.allControls = [];
                this.currentView = 'cards';
                this.currentControls = [];
                this.currentDomain = '';
                this.complianceStatus = new Map();
                this.comments = new Map();
                this.filters = {
                    search: '',
                    domain: '',
                };
                this.loadComplianceStatus();
                this.loadComments();
            }

            init() {
                console.log('üìã Initializing CCM App...');
                
                // Check if controls are loaded
                if (!window.CCM_BASE_CONTROLS || !window.AZURE_CCM_CONTROLS_MAPPING) {
                    console.error('‚ùå Controls not loaded!');
                    this.showError('CCM data not loaded. Check console for details.');
                    return;
                }

                // Combine controls with Azure mappings
                this.allControls = window.CCM_BASE_CONTROLS.map(control => ({
                    ...control,
                    azureMapping: window.AZURE_CCM_CONTROLS_MAPPING[control.id] || 'N/A'
                }));

                console.log('‚úÖ Loaded', this.allControls.length, 'CCM controls');

                // Update statistics
                document.getElementById('totalControls').textContent = this.allControls.length;
                document.getElementById('azureMappings').textContent = 
                    Object.keys(window.AZURE_CCM_CONTROLS_MAPPING).length;

                // Bind events
                this.bindEvents();
                this.initViewModes();

                // Initial render
                this.applyFilters();

                // Update status
                document.getElementById('statusIndicator').textContent = '‚úÖ';
                document.getElementById('statusText').textContent = 
                    `Ready - ${this.allControls.length} controls loaded`;
                
                // Hide loading spinner
                const spinner = document.getElementById('loadingSpinner');
                if (spinner) spinner.style.display = 'none';
                
                console.log('‚úÖ CCM App initialized successfully!');
            }

            bindEvents() {
                // Search input
                document.getElementById('searchInput').addEventListener('input', (e) => {
                    this.filters.search = e.target.value.toLowerCase();
                    this.applyFilters();
                });

                // Domain filter
                document.getElementById('domainFilter').addEventListener('change', (e) => {
                    this.filters.domain = e.target.value;
                    this.applyFilters();
                });
            }

            applyFilters() {
                let filtered = this.allControls;

                // Apply search filter
                if (this.filters.search) {
                    filtered = filtered.filter(control =>
                        control.id.toLowerCase().includes(this.filters.search) ||
                        control.title.toLowerCase().includes(this.filters.search) ||
                        control.description.toLowerCase().includes(this.filters.search) ||
                        control.domainName.toLowerCase().includes(this.filters.search)
                    );
                }

            // Apply domain filter
            if (this.filters.domain) {
                filtered = filtered.filter(control => control.domain === this.filters.domain);
            }

            this.currentControls = filtered;
            this.renderControls();
            }

            renderControls() {
                const grid = document.getElementById('controlsGrid');
                grid.innerHTML = '';

                if (this.currentControls.length === 0) {
                    grid.innerHTML = '<p style="text-align: center; color: #666; padding: 2rem;">No controls match your filters.</p>';
                    return;
                }

                // Simply render all controls without grouping by domain
                this.currentControls.forEach(control => {
                    grid.appendChild(this.createControlCard(control));
                });
            }

            createControlCard(control) {
                const card = document.createElement('div');
                card.className = 'control-card';
                
                const applicabilityClass = control.applicability.includes('Both') ? 'applicability-both' :
                                          control.applicability.includes('CSP') ? 'applicability-csp' :
                                          'applicability-csc';
                
                card.innerHTML = `
                    <div class="control-header">
                        <div class="control-id">${this.escapeHtml(control.id)}</div>
                        <span class="control-applicability ${applicabilityClass}">
                            ${this.escapeHtml(control.applicability)}
                        </span>
                    </div>
                    <div class="control-title">${this.escapeHtml(control.title)}</div>
                    
                    <div style="margin: 1rem 0;">
                        <strong style="color: #333;">Description:</strong>
                        <p style="color: #666; margin-top: 0.5rem;">${this.escapeHtml(control.description)}</p>
                    </div>

                    <div class="control-specification">
                        <h4>üìã Control Specification</h4>
                        <div>${this.escapeHtml(control.controlSpecification)}</div>
                    </div>
                    
                    <div class="implementation-guide" style="background: #e3f2fd; border-left-color: #0078d4;">
                        <h4 style="color: #0078d4;">üî∑ Azure Implementation</h4>
                        <div>${this.escapeHtml(control.azureMapping)}</div>
                    </div>

                    <div class="compliance-status-section">
                        <h4>‚úì Compliance Status</h4>
                        <div class="compliance-status-buttons">
                            <button class="status-btn status-implemented ${this.getComplianceStatus(control.id) === 'implemented' ? 'active' : ''}" 
                                    onclick="window.app.setComplianceStatus('${control.id}', 'implemented')">
                                Implemented
                            </button>
                            <button class="status-btn status-partial ${this.getComplianceStatus(control.id) === 'partial' ? 'active' : ''}" 
                                    onclick="window.app.setComplianceStatus('${control.id}', 'partial')">
                                Partial
                            </button>
                            <button class="status-btn status-not-implemented ${this.getComplianceStatus(control.id) === 'not-implemented' ? 'active' : ''}" 
                                    onclick="window.app.setComplianceStatus('${control.id}', 'not-implemented')">
                                Not Implemented
                            </button>
                            <button class="status-btn status-not-applicable ${this.getComplianceStatus(control.id) === 'not-applicable' ? 'active' : ''}" 
                                    onclick="window.app.setComplianceStatus('${control.id}', 'not-applicable')">
                                N/A
                            </button>
                        </div>
                        
                        <div class="auditor-comment-section">
                            <label for="comment-${control.id}" class="comment-label">
                                üí¨ Auditor Comments / Notes:
                            </label>
                            <textarea 
                                id="comment-${control.id}" 
                                class="auditor-comment-textarea"
                                placeholder="Add implementation notes, evidence references, remediation plans, or any other relevant comments..."
                                onblur="window.app.saveComment('${control.id}', this.value)"
                            >${this.escapeHtml(this.getComment(control.id))}</textarea>
                        </div>
                    </div>
                `;
                
                return card;
            }

            escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }

            showError(message) {
                const grid = document.getElementById('controlsGrid');
                grid.innerHTML = `
                    <div style="text-align: center; padding: 2rem; color: #d32f2f;">
                        <h3>‚ö†Ô∏è Error</h3>
                        <p>${message}</p>
                    </div>
                `;
            }

            loadComplianceStatus() {
                const saved = localStorage.getItem('ccm_compliance_status');
                if (saved) {
                    try {
                        const data = JSON.parse(saved);
                        this.complianceStatus = new Map(Object.entries(data));
                    } catch (e) {
                        console.error('Failed to load compliance status:', e);
                    }
                }
            }

            saveComplianceStatus() {
                const data = Object.fromEntries(this.complianceStatus);
                localStorage.setItem('ccm_compliance_status', JSON.stringify(data));
            }

            setComplianceStatus(controlId, status) {
                this.complianceStatus.set(controlId, status);
                this.saveComplianceStatus();
                this.renderControls();
            }

            getComplianceStatus(controlId) {
                return this.complianceStatus.get(controlId) || '';
            }

            getStatusDisplayName(status) {
                // Convert status codes to display-friendly names
                const displayNames = {
                    'implemented': 'Implemented',
                    'partial': 'Partial',
                    'not-implemented': 'Not Implemented',
                    'not-applicable': 'Not Applicable'
                };
                return displayNames[status] || 'Not Implemented';
            }

            loadComments() {
                const saved = localStorage.getItem('ccm_auditor_comments');
                if (saved) {
                    try {
                        const data = JSON.parse(saved);
                        this.comments = new Map(Object.entries(data));
                    } catch (e) {
                        console.error('Failed to load comments:', e);
                    }
                }
            }

            saveComment(controlId, comment) {
                this.comments.set(controlId, comment);
                const data = Object.fromEntries(this.comments);
                localStorage.setItem('ccm_auditor_comments', JSON.stringify(data));
            }

            getComment(controlId) {
                return this.comments.get(controlId) || '';
            }
            
            showExportDialog() {
                const dialog = document.getElementById('exportDialog');
                if (dialog) dialog.hidden = false;
            }
            
            closeExportDialog() {
                const dialog = document.getElementById('exportDialog');
                if (dialog) dialog.hidden = true;
            }
            
            exportToPDF() {
                try {
                    if (!window.jspdf || !window.jspdf.jsPDF) {
                        alert('PDF library not loaded. Please refresh the page.');
                        return;
                    }

                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF();

                    const controls = this.currentControls;

                    // Title
                    doc.setFontSize(18);
                    doc.setFont(undefined, 'bold');
                    doc.text('CSA Cloud Controls Matrix v4 Audit Report', 15, 20);

                    // Metadata
                    doc.setFontSize(10);
                    doc.setFont(undefined, 'normal');
                    doc.text(`Generated: ${new Date().toLocaleDateString()}`, 15, 30);
                    doc.text(`Total Controls: ${controls.length}`, 15, 36);

                    // Status summary
                    const statusCounts = {
                        'Implemented': 0,
                        'Partial': 0,
                        'Not Implemented': 0,
                        'Not Applicable': 0
                    };

                    this.allControls.forEach(c => {
                        const statusCode = this.getComplianceStatus(c.id);
                        const statusName = this.getStatusDisplayName(statusCode);
                        if (statusName in statusCounts) {
                            statusCounts[statusName]++;
                        }
                    });

                    let yPos = 45;
                    doc.setFontSize(10);
                    doc.text('Status Summary:', 15, yPos);
                    yPos += 6;
                    Object.entries(statusCounts).forEach(([status, count]) => {
                        doc.text(`  ${status}: ${count}`, 15, yPos);
                        yPos += 5;
                    });

                    // Controls list
                    yPos += 10;
                    doc.setFontSize(12);
                    doc.setFont(undefined, 'bold');
                    doc.text('Controls:', 15, yPos);
                    yPos += 8;

                    doc.setFontSize(9);
                    controls.forEach((control) => {
                        if (yPos > 270) {
                            doc.addPage();
                            yPos = 20;
                        }

                        const statusCode = this.getComplianceStatus(control.id);
                        const statusName = this.getStatusDisplayName(statusCode);

                        doc.setFont(undefined, 'bold');
                        doc.text(`${control.id}: ${control.title}`, 15, yPos);
                        yPos += 5;

                        doc.setFont(undefined, 'normal');
                        doc.text(`Domain: ${control.domainName}`, 15, yPos);
                        yPos += 5;

                        doc.text(`Status: ${statusName}`, 15, yPos);
                        yPos += 10;
                    });

                    // Save PDF
                    const timestamp = new Date().toISOString().slice(0, 10);
                    doc.save(`CSA_CCM_v4_Audit_Report_${timestamp}.pdf`);

                    this.closeExportDialog();
                    alert('‚úÖ PDF report exported successfully!');
                } catch (error) {
                    console.error('PDF export error:', error);
                    alert('Failed to export PDF report. See console for details.');
                }
            }
            
            initViewModes() {
                const viewButtons = document.querySelectorAll('.view-btn');
                viewButtons.forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const view = e.currentTarget.dataset.view;
                        this.switchView(view);
                    });
                });
            }
            
            switchView(view) {
                this.currentView = view;
                
                // Update active button
                document.querySelectorAll('.view-btn').forEach(btn => {
                    btn.classList.toggle('active', btn.dataset.view === view);
                });
                
                // Re-render controls in new view
                this.renderControls(this.currentControls);
            }
            
            resetFilters() {
                document.getElementById('searchInput').value = '';
                document.getElementById('domainFilter').value = '';
                this.filters = { search: '', domain: '' };
                this.applyFilters();
            }
            
            exportToExcel() {
                try {
                    if (!window.XLSX) {
                        alert('Excel export library not loaded');
                        return;
                    }

                    const controls = this.currentControls;
                    
                    if (!controls || controls.length === 0) {
                        alert('No controls to export. Please ensure controls are loaded.');
                        return;
                    }

                    const data = controls.map(c => ({
                'Control ID': c.id,
                'Domain': c.domain,
                'Domain Name': c.domainName,
                'Title': c.title,
                'Description': c.description,
                'Control Specification': c.controlSpecification,
                'Applicability': c.applicability,
                'Category': c.category,
                'Azure Services': c.azureMapping,
                'Compliance Status': this.getComplianceStatus(c.id) || 'Not Set',
                'Auditor Comments': this.getComment(c.id) || ''
            }));

                const ws = XLSX.utils.json_to_sheet(data);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, 'CCM Controls');

                // Auto-size columns
                const maxWidth = 50;
                const wscols = [
                    { wch: 10 },  // Control ID
                    { wch: 8 },   // Domain
                    { wch: 30 },  // Domain Name
                    { wch: 40 },  // Title
                    { wch: maxWidth },  // Description
                    { wch: maxWidth },  // Control Specification
                    { wch: 20 },  // Applicability
                    { wch: 15 },  // Category
                    { wch: maxWidth },  // Azure Services
                    { wch: 20 },  // Compliance Status
                    { wch: maxWidth }   // Auditor Comments
                ];
                ws['!cols'] = wscols;

                    const timestamp = new Date().toISOString().slice(0, 10);
                    XLSX.writeFile(wb, `CSA_CCM_v4_Azure_Audit_Report_${timestamp}.xlsx`);
                    
                    this.closeExportDialog();
                    alert('‚úÖ Excel report exported successfully!');
                } catch (error) {
                    console.error('Excel export error:', error);
                    alert('Failed to export Excel report. See console for details.');
                }
            }
        }

        // Initialize app when DOM is ready
        document.addEventListener('DOMContentLoaded', function() {
            try {
                // Verify data is loaded
                if (!window.CCM_BASE_CONTROLS || !window.AZURE_CCM_CONTROLS_MAPPING) {
                    console.error('‚ùå Missing data files');
                    alert('ERROR: CCM data files are not loading. Please check:\n\n1. ccm-base-controls.js exists\n2. azure-ccm-controls.js exists\n3. Check browser console (F12) for errors');
                    return;
                }
                
                window.app = new CCMApp();
                window.app.init();
            } catch (error) {
                console.error('‚ùå Initialization error:', error);
                alert('Initialization failed: ' + error.message);
            }
        });

        console.log('üí° CCM application script loaded');
    </script>
</body>
</html>